{{ define "main" }}
<article class="quiz-page">
  <div class="quiz-header">
    <h1>{{ .Title }}</h1>
    {{ .Content }}
  </div>

  {{ $qs := .Params.questions }}
  {{ if not $qs }}
    <p><em>No questions defined.</em></p>
  {{ else }}

  <div class="quiz-stats">
    <span><strong>Total Questions:</strong> {{ len $qs }}</span>
    <span><strong>Time:</strong> Unlimited</span>
  </div>

  <div class="quiz">
    {{ range $idx, $q := $qs }}
    <div class="question question-{{ $q.type }}"
         data-question="{{ $idx }}"
         data-type="{{ $q.type }}"
         data-answer="{{ if eq $q.type "single" }}{{ $q.answer }}{{ else }}{{ delimit $q.answer "," }}{{ end }}"
         data-points="{{ default 1 $q.points }}">

      <div class="question-header">
        <span class="question-type">
          {{ if eq $q.type "single" }}Single Choice{{ else }}Multiple Choice{{ end }}
        </span>
      </div>

      <div class="stem">
        {{ $q.text | markdownify }}
      </div>

      {{ if eq $q.type "single" }}
        <ul class="choices">
          {{ range $i, $c := $q.choices }}
          <li>
            <label>
              <input type="radio" name="q{{ $idx }}" value="{{ $i }}">
              <span>{{ $c }}</span>
            </label>
          </li>
          {{ end }}
        </ul>
      {{ else if eq $q.type "multi" }}
        <ul class="choices">
          {{ range $i, $c := $q.choices }}
          <li>
            <label>
              <input type="checkbox" name="q{{ $idx }}" value="{{ $i }}">
              <span>{{ $c }}</span>
            </label>
          </li>
          {{ end }}
        </ul>
      {{ else }}
        <p><em>Invalid question type "{{ $q.type }}".</em></p>
      {{ end }}

      {{ if $q.hint }}
        <button class="hint-button" onclick="toggleHint({{ $idx }})">Hint</button>
        <div class="hint" id="hint{{ $idx }}">
          <strong>ðŸ’¡ Hint:</strong> {{ $q.hint | markdownify }}
        </div>
      {{ end }}

      <div class="answer" id="answer{{ $idx }}">
        {{ if eq $q.type "single" }}
          <p><strong>âœ… Correct answer:</strong> {{ index $q.choices $q.answer }}</p>
        {{ else if eq $q.type "multi" }}
          <p><strong>âœ… Correct answers:</strong>
            {{ range $i, $a := $q.answer }}
              {{ index $q.choices $a }}{{ if ne $i (sub (len $q.answer) 1) }}, {{ end }}
            {{ end }}
          </p>
        {{ end }}
        <div class="result-message" id="result{{ $idx }}"></div>
      </div>
    </div>
    {{ end }}
  </div>
  <!-- QUESTIONS END -->

  <div class="quiz-footer">
    <button onclick="submitAnswers()">Submit</button>
    <button class="reset-btn" onclick="resetSelections()">Reset</button>

    <div class="score-display" id="scoreDisplay">
      <div style="font-size: 24px; margin-bottom: 10px;">
        Score: <span id="score">0</span> / <span id="total">0</span> (<span id="percentage">0</span>%)
      </div>
      <div class="score-breakdown">
        <span>Points Earned: <span id="scorePoints">0</span></span>
        <span>Total Points: <span id="maxPoints">0</span></span>
        <span>Questions: {{ len $qs }}</span>
      </div>
    </div>
  </div>

  <script>
    function toggleHint(i) {
      document.getElementById(`hint${i}`).classList.toggle('show');
    }

    function getSelectedAnswers(i) {
      return [...document.querySelectorAll(`input[name="q${i}"]:checked`)].map(el => +el.value);
    }

    function submitAnswers() {
      const questions = document.querySelectorAll('.question');
      let score = 0,
          max   = 0;

      questions.forEach((q, i) => {
        const type   = q.dataset.type;
        const answer = q.dataset.answer;
        const pts    = +q.dataset.points;
        const sel    = getSelectedAnswers(i);

        max += pts;

        let correct = false;
        if (type === 'single') {
          correct = sel.length === 1 && sel[0] === +answer;
        } else if (type === 'multi') {
          const right = answer.split(',').map(Number).sort();
          const user  = sel.sort();
          correct = right.length === user.length && right.every((v, j) => v === user[j]);
        }

        q.classList.toggle('correct',   correct);
        q.classList.toggle('incorrect', !correct);

        const ansBox = document.getElementById(`answer${i}`);
        const res    = document.getElementById(`result${i}`);
        ansBox.classList.add('show');

        if (correct) {
          score += pts;
          res.innerHTML = `<span class="result-icon" style="color:#28a745;">âœ“</span> Correct! (+${pts} ${pts===1?'point':'points'})`;
        } else {
          res.innerHTML = `<span class="result-icon" style="color:#dc3545;">âœ—</span> Incorrect (0 points)`;
        }
      });

      const pct = Math.round(score / max * 100);
      document.getElementById('score').textContent       = score;
      document.getElementById('total').textContent       = max;
      document.getElementById('percentage').textContent  = pct;
      document.getElementById('scorePoints').textContent = score;
      document.getElementById('maxPoints').textContent   = max;

      const sd = document.getElementById('scoreDisplay');
      sd.style.display = 'block';
      sd.style.color   = pct >= 70 ? '#28a745' : pct >= 50 ? '#ffc107' : '#dc3545';
      sd.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function resetSelections() {
      document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(el => el.checked = false);
      document.querySelectorAll('.answer, .hint').forEach(el => el.classList.remove('show'));
      document.querySelectorAll('.question').forEach(q => q.classList.remove('correct', 'incorrect'));
      document.getElementById('scoreDisplay').style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>

  {{ end }}
</article>
{{ end }}